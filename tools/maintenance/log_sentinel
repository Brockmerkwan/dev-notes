#!/bin/zsh
set -euo pipefail
setopt NULL_GLOB

LOCK="/tmp/log_sentinel.lock"
if ! mkdir "$LOCK" 2>/dev/null; then
  # another instance is running
  exit 0
fi
trap 'rmdir "$LOCK" 2>/dev/null || true' EXIT

SRC_DIR="$HOME/Projects/devnotes"
OUT_DIR="$HOME/Projects/devnotes/backups"
LOG="$OUT_DIR/daily_rotate.log"
mkdir -p "$OUT_DIR"

ts(){ date '+%Y-%m-%d %H:%M:%S'; }
pack_if_any() {
  local out="$1"; shift
  local files=("$@")
  (( ${#files} )) && tar -czf "$out" -C "$SRC_DIR" "${files[@]/#${SRC_DIR}\//}" || true
}

echo "[$(ts)] start rotation" >> "$LOG"
pack_if_any "$OUT_DIR/devnotes_$(date +%Y%m%d_%H%M%S).tar.gz" "$SRC_DIR"/daily_*
pack_if_any "$OUT_DIR/daily_$(date +%Y%m%d_%H%M%S).tar.gz"    "$SRC_DIR"/notes_*
# keep last 7
ls -1t "$OUT_DIR"/*.tar.gz 2>/dev/null | tail -n +8 | xargs -I{} rm -f "{}" 2>/dev/null || true
echo "[$(ts)] done" >> "$LOG"
